<!DOCTYPE html>
<html>

<head>
    <!-- Required meta tags-->
    <meta charset="utf-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <!-- Color theme for statusbar (Android only) -->
    <meta name="theme-color" content="#2196f3">
    <!-- Your app title -->
    <title>Ana Lima Moda</title>
    <!-- Path to Framework7 Library Bundle CSS -->
    <link rel="stylesheet" href="lib/framework7-bundle.min.css">
    <!-- CSS PERSONALIZADO PARA MENU-->
    <link rel="stylesheet" href="css/index.css">
    <!--Ícones Material Design-->
    <link rel="stylesheet" href="css/materialdesignicons.min.css">
    <!--Ícones Material Design-->
    <link rel="stylesheet" href="css/remixicon.css">


</head>

<body>
    <!-- App root element -->
    <div id="app">
        <!-- Popup para adicionar produto -->
        <div class="popup popup-produto custom-popup-anim" id="popup-add-produto">
          <div class="view">
            <div class="page">
              <div class="navbar">
                <div class="navbar-inner">
                  <div class="title">Novo Produto</div>
                  <div class="right">
                    <a href="#" class="link popup-close icon-only">
                      <i class="ri-close-line"></i>
                    </a>
                  </div>                  
                </div>
              </div>
              <div class="page-content">
                <div class="block">
                  <div class="list no-hairlines-md">
                    <ul>
                      <li class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">Nome do Produto</div>
                          <div class="item-input-wrap">
                            <input type="text" id="input-nome-produto" placeholder="Digite o nome" />
                          </div>
                        </div>
                      </li>
                      <li class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">Código</div>
                          <div class="item-input-wrap input-codigo-wrap">
                            <input type="text" id="input-codigo-produto" placeholder="Código" />
                            <button id="btn-scan-codigo">
                              <i class="ri-camera-line"></i>
                            </button>
                          </div>
                        </div>
                      </li>
                      <li class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">Marca</div>
                          <div class="item-input-wrap">
                            <input type="text" id="input-marca-produto" placeholder="Marca" />
                          </div>
                        </div>
                      </li>
                      <li class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">Tamanho</div>
                          <div class="item-input-wrap">
                            <input type="text" id="input-tamanho-produto" placeholder="Tamanho" />
                          </div>
                        </div>
                      </li>
                      <li class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">Cor</div>
                          <div class="item-input-wrap">
                            <input type="text" id="input-cor-produto" placeholder="Cor" />
                          </div>
                        </div>
                      </li>
                      <li class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">Preço de Custo</div>
                          <div class="item-input-wrap">
                            <input type="number" id="input-preco-custo-produto" placeholder="Ex: 25.50" step="0.01" />
                          </div>
                        </div>
                      </li>
                      <li class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">Preço de Venda</div>
                          <div class="item-input-wrap">
                            <input type="number" id="input-preco-venda-produto" placeholder="Ex: 25.50" step="0.01" />
                          </div>
                        </div>
                      </li>
                      <li class="item-content item-input">
                        <div class="item-inner">
                          <div class="item-title item-label">Quantidade Atual</div>
                          <div class="item-input-wrap">
                            <input type="number" id="input-qtd-atual-produto" placeholder="Quantidade" />
                          </div>
                        </div>
                      </li>
                    </ul>
                  </div>
                  <div class="block">
                    <a href="#" class="button button-fill" id="btn-add-produto">Adicionar</a>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>

        <!-- Your main view, should have "view-main" class -->
        <div class="view view-main">

            <!-- TAB BAR-->
            <div class="toolbar toolbar-bottom">
                <div class="toolbar-inner display-flex">
                    <a href="/loadingindex/" class="tab-link link active">
                        <i class="ri-t-shirt-line"></i>
                        <span>Estoque</span>
                    </a>
                    <a href="/loadinglink2/" class="tab-link link">
                        <i class="ri-arrow-left-right-line"></i>
                        <span>Entada/Saída</span>
                    </a>
                    <a href="/loadinglink3/" class="tab-link link">
                        <i class="ri-user-line"></i>
                        <span>Clientes</span>
                    </a>
                    <a href="/loadinglink4/" class="tab-link link">
                        <i class="ri-align-justify"></i>
                        <span>Configurações</span>
                    </a>

                </div>
            </div>

            <!-- Initial Page, "data-name" contains page name -->
            <div data-name="index" class="page color-theme-blue">

                

                <!-- Top Navbar -->
                <div class="navbar">
                    <div class="navbar-bg"></div>
                    <div class="navbar-inner">
                    
                    <!-- Botão de Adição à Esquerda -->
                    <div class="left">
                      <a href="#" class="link icon-only popup-open" data-popup="#popup-add-produto">
                        <i class="ri-add-line"></i>
                      </a>
                      
                    </div>
                
                    <!-- Título Centralizado -->
                    <div class="title" id="app-title">Ana Lima Moda</div>
                    
                    <!-- Campo de Busca -->
                    <form class="searchbar searchbar-init hidden" data-search-container=".card-list" data-search-in=".card-content">
                      <div class="searchbar-inner">
                        <div class="searchbar-input-wrap">
                          <input type="text" id="searchInput" class="search-box" placeholder="Buscar produto...">
                          <i class="searchbar-icon"></i>
                          <span class="input-clear-button"></span>
                        </div>
                        <span class="searchbar-disable-button if-not-aurora">Cancelar</span>
                      </div>
                    </form>


                    <!-- Botão de Busca à Direita -->
                    <div class="right">
                      <a href="#" class="link icon-only" id="btnBuscar">
                        <i id="searchIcon" class="ri-search-line"></i>
                      </a>
                    </div>        
                    </div>
                </div>
  

                <!-- Scrollable page content -->
                <div class="page-content ptr-content">
                    <div class="ptr-preloader">
                      <div class="preloader"></div>
                      <div class="ptr-arrow"></div>
                    </div>
                    
                    
                    <!-- Preloader -->
                    <div id="preloader" style="display: none; text-align: center; margin: 50px 0;">
                      <div class="preloader"></div>
                    </div>
                    <div id="produtos" class="block grid grid-cols-1 gap-2 card-list" style="padding: 10px;"></div>

                    <!-- Botão flutuante para filtros -->
                    <div class="fab-container">
                      <button id="filterButton" class="filtro-icon">
                        <i class="ri-filter-line"></i> <!-- Ícone de filtro -->
                      </button>
                    </div>

                    <div class="popup custom-popup-anim" id="popup-filtros">
                      <div class="view">
                        <div class="page">
                          <div class="navbar">
                            <div class="navbar-inner">
                              <div class="title">Filtros</div>
                              <div class="right">
                                <a href="#" class="link popup-close"><i class="ri-close-line"></i></a>
                              </div>
                            </div>
                          </div>
                          <div class="page-content">
                            <div class="block">
                              <form id="filtrosForm">
                                <input type="checkbox" name="filtro" value="camiseta" id="chk-camiseta">
                                <label for="chk-camiseta">Camiseta</label><br>
                                <input type="checkbox" name="filtro" value="calca" id="chk-calca">
                                <label for="chk-calca">Calça</label><br>
                                <input type="checkbox" name="filtro" value="jaqueta" id="chk-jaqueta">
                                <label for="chk-jaqueta">Jaqueta</label><br>
                                <input type="checkbox" name="filtro" value="tam: gg" id="chk-gg">
                                <label for="chk-gg">Tam: GG</label><br>
                                <input type="checkbox" name="filtro" value="cor: branco" id="chk-branco">
                                <label for="chk-branco">Cor: Branco</label><br>
                              </form>
                              <br>
                              <button class="button button-fill" id="aplicarFiltrosBtn">Aplicar</button>
                              <button class="button button-outline color-red" id="limparFiltrosBtn">Limpar Filtros</button>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  
            </div>
        </div>
    </div>
    <!-- Path to Framework7 Library Bundle JS-->
    <script type="text/javascript" src="lib/framework7-bundle.min.js"></script>
	  <!-- jQuery -->
	  <script type="text/javascript" src="lib/jquery-3.7.0.min.js"></script>	
    <script src="js/funcoes.js"></script>
    <!-- Roteamento do app-->
    <script type="text/javascript" src="js/routes.js"></script>
    <script src="cordova.js"></script>

    <script>
      app.ptr.done(); // usa o app já existente
  
      // Usar Dom7 (o "jQuery" do Framework7)
      var $$ = Dom7;
  
      // Evento quando o usuário puxa para atualizar
      $$('.ptr-content').on('ptr:refresh', function (e) {
          // Simula uma requisição de rede ou recarregamento
          setTimeout(function () {
              app.ptr.done(); // Finaliza o preload
              carregarProdutos();
          });
      });
  
      var searchbar;
      var isSearchVisible = false;

      $$('#btnBuscar').on('click', function () {
        if (!searchbar) {
          searchbar = app.searchbar.create({
            el: '.searchbar',
            customSearch: true,
            on: {
              search: function (sb, query) {
                console.log('Searchbar (via botão) digitou:', query); // DEBUG
                $$('.card').each(function () {
                  const text = $$(this).text().toLowerCase(); // <- Aqui pega o texto do card inteiro
                  if (text.includes(query.toLowerCase()) || query.trim() === '') {
                    $$(this).show();
                  } else {
                    $$(this).hide();
                  }
                });
              }
            }
          });
        }

        if (!isSearchVisible) {
          $$('.searchbar').removeClass('hidden');
          $$('#app-title').addClass('hidden'); // esconde o título
          $$('#searchIcon').removeClass('ri-search-line').addClass('ri-close-line');
          isSearchVisible = true;
          
          setTimeout(() => {
            $$('.searchbar input').focus();
          }, 200);
          
        } else {
          $$('.searchbar').addClass('hidden');
          $$('#searchIcon').removeClass('ri-close-line').addClass('ri-search-line');
          isSearchVisible = false;
          setTimeout(() => {
            $$('#searchInput').val('');
            $$('#app-title').removeClass('hidden'); // mostra o título de volta
          }, 200); // sincroniza com o tempo da animação da searchbar

          // exibe todos os cards novamente
          $$('.card').show();

        }
      });
      
      $$('#searchInput').on('input', function () {
        const query = $$(this).val().toLowerCase();
        console.log('Digitado no campo de busca:', query); // DEBUG
        $$('.card').each(function () {
          const text = $$(this).text().toLowerCase(); // <- Aqui também
          if (text.includes(query) || query.trim() === '') {
            $$(this).show();
          } else {
            $$(this).hide();
          }
        });
      });

      $$('#btn-add-produto').on('click', function () {
        const nome = $$('#input-nome-produto').val().trim();
        const codigo = $$('#input-codigo-produto').val().trim();
        const marca = $$('#input-marca-produto').val().trim();
        const tamanho = $$('#input-tamanho-produto').val().trim();
        const cor = $$('#input-cor-produto').val().trim();
        const precoCusto = parseFloat($$('#input-preco-custo-produto').val().trim()) || 0;
        const precoVenda = parseFloat($$('#input-preco-venda-produto').val().trim()) || 0;
        const qtdAtual = parseInt($$('#input-qtd-atual-produto').val().trim()) || 1;

        if (codigo) {
          fetch("https://script.google.com/macros/s/AKfycbyXDWkX4mXl8-3gCIQ3hfgtjEQw6idQmSJmCqv_9W8F3_ebLHkVTy8yFAAti9jFCuhUBg/exec", {
            method: 'POST',
            mode: 'no-cors', // evita CORS no app Cordova
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              nome,
              codigo,
              marca,
              tamanho,
              cor,
              precoCusto,
              precoVenda,
              qtdAtual
            })
          });

          // Fecha popup e limpa campos
          app.popup.close('#popup-add-produto');
          $$('#input-nome-produto').val('');
          $$('#input-codigo-produto').val('');
          $$('#input-marca-produto').val('');
          $$('#input-tamanho-produto').val('');
          $$('#input-cor-produto').val('');
          $$('#input-preco-custo-produto').val('');
          $$('#input-preco-venda-produto').val('');
          $$('#input-qtd-atual-produto').val('');

          $$('#preloader').show();
          setTimeout(() => {
            carregarProdutos();
          }, 10000);
        } else {
          app.dialog.alert('Por favor, insira pelo menos o código do produto.');
        }
      });

      document.addEventListener('deviceready', function () {
      $$('#btn-scan-codigo').on('click', function () {
        cordova.plugins.barcodeScanner.scan(
          function (result) {
            if (!result.cancelled) {
              $$('#input-codigo-produto').val(result.text);
            }
          },
          function (error) {
            app.dialog.alert("Falha ao escanear o código: " + error);
          },
          {
            preferFrontCamera: false, // usa câmera traseira
            showFlipCameraButton: true,
            showTorchButton: true,
            prompt: "Aponte para o código de barras",
            formats: "CODE_128,CODE_39,EAN_13,EAN_8,QR_CODE", // formatos aceitos
            orientation: "portrait"
          }
        );
      });
    });


      // Abrir popup de filtros ao clicar no botão flutuante
      $$('#filterButton').on('click', function () {
        app.popup.open('#popup-filtros');
      });

      // Aplicar filtros selecionados
      $$('#aplicarFiltrosBtn').on('click', function () {
        const filtrosSelecionados = [];
        $$('#filtrosForm input[type="checkbox"]:checked').each(function () {
          filtrosSelecionados.push($$(this).val().toLowerCase());
        });

        console.log('Filtros aplicados:', filtrosSelecionados); // debug

        $$('.card').each(function () {
          const card = $$(this);
          const textoCard = card.text().toLowerCase(); // pega todo o texto do card

          // Verifica se algum filtro bate com o texto do card
          const corresponde = filtrosSelecionados.some(filtro => textoCard.includes(filtro));

          if (corresponde || filtrosSelecionados.length === 0) {
            card.show();
          } else {
            card.hide();
          }
        });

        app.popup.close('#popup-filtros');
      });

      // Botão para limpar os filtros
      $$('#limparFiltrosBtn').on('click', function () {
        // Desmarca todos os checkboxes
        $$('#filtrosForm input[type="checkbox"]').prop('checked', false);

        // Mostra todos os cards novamente
        $$('.card').show();

        // Fecha o popup
        app.popup.close('#popup-filtros');
      });
    </script>

    <script>

      document.addEventListener('DOMContentLoaded', function () {
        // Mostrar preloader inicialmente
        $$('#preloader').show();

        // Simula um delay (você pode remover o setTimeout depois se quiser)
        setTimeout(() => {
          carregarProdutos(); // sua função que popula os registros
          $$('#preloader').hide(); // Esconde o preloader depois do carregamento
        }, 2000); // tempo simulado para carregamento
      });

      // Esconde os cards ao sair da página index
      $$(document).on('page:beforeout', '.page[data-name="index"]', function () {
        console.log('Saindo da index, ocultando cards');
        $$('#produtos').hide();
      });

      // Mostra os cards ao retornar para a página index
      $$(document).on('page:afterin', '.page[data-name="index"]', function () {
        console.log('Voltando para index, mostrando cards');
        $$('#produtos').show();
      });
    </script>
  
</body>  

</html>